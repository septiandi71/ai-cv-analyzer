// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

// Status untuk evaluation job
enum EvaluationStatus {
  QUEUED      // Job baru masuk queue
  PROCESSING  // Sedang diproses oleh worker
  COMPLETED   // Selesai dengan sukses
  FAILED      // Gagal setelah retry
}

// Tipe dokumen yang diupload
enum FileType {
  CV
  PROJECT_REPORT
}

// ============================================================================
// MODELS
// ============================================================================

// Model untuk file yang diupload (CV atau Project Report)
// Using snake_case for column names to match API response format (PostgreSQL standard)
model UploadedFile {
  id               String   @id @default(uuid())
  type             FileType // CV atau PROJECT_REPORT
  
  // File metadata
  originalFilename String   @map("original_filename")
  storedFilename   String   @unique @map("stored_filename") // Filename di storage
  filePath         String   @map("file_path")              // Full path ke file
  mimeType         String   @map("mime_type")              // application/pdf
  fileSize         Int      @map("file_size")              // Size in bytes
  
  // Extracted content (PENTING untuk RAG!)
  extractedText    String   @db.Text @map("extracted_text") // Text dari PDF
  pageCount        Int      @default(0) @map("page_count")
  
  // Relations
  jobsAsCv              EvaluationJob[] @relation("CvFiles")
  jobsAsProjectReport   EvaluationJob[] @relation("ProjectReportFiles")
  
  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  
  @@map("uploaded_files")
  @@index([type])
  @@index([createdAt])
}

// Model utama untuk evaluation job (MERGED dengan result)
// Using snake_case for column names to match API response format (PostgreSQL standard)
model EvaluationJob {
  id        String            @id @default(uuid())
  status    EvaluationStatus  @default(QUEUED)
  jobTitle  String            @map("job_title") // Job title dari input user
  
  // Foreign keys
  cvFileId            String @map("cv_file_id")
  projectReportFileId String @map("project_report_file_id")
  
  // Relations
  cvFile              UploadedFile @relation("CvFiles", fields: [cvFileId], references: [id], onDelete: Cascade)
  projectReportFile   UploadedFile @relation("ProjectReportFiles", fields: [projectReportFileId], references: [id], onDelete: Cascade)
  
  // ========================================================================
  // EVALUATION RESULTS (nullable, diisi saat COMPLETED)
  // ========================================================================
  
  // --- CV Evaluation ---
  cvMatchRate     Float?  @map("cv_match_rate")      // 0.0 - 1.0
  cvFeedback      String? @map("cv_feedback") @db.Text
  cvScoresJson    Json?   @map("cv_scores_json")     // Detailed breakdown: technical, experience, achievements, cultural
  
  // --- Project Evaluation ---
  projectScore    Float?  @map("project_score")      // 1.0 - 5.0
  projectFeedback String? @map("project_feedback") @db.Text
  projectScoresJson Json? @map("project_scores_json") // Detailed breakdown: correctness, quality, resilience, docs, creativity
  
  // --- Overall Summary ---
  overallSummary  String? @map("overall_summary") @db.Text
  
  // ========================================================================
  // METADATA & TRACKING
  // ========================================================================
  
  // LLM metadata
  llmProvider     String? @map("llm_provider")       // gemini/openrouter
  llmModel        String? @map("llm_model")          // gemini-1.5-flash
  tokensUsed      Int?    @map("tokens_used")        // Total tokens consumed
  
  // Performance tracking
  processingTimeMs Int?   @map("processing_time_ms") // Processing time in milliseconds
  
  // Error tracking
  error           String? @db.Text                   // Error message if FAILED
  attempts        Int     @default(0)                // Retry attempts
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  startedAt       DateTime? @map("started_at")       // When processing started
  completedAt     DateTime? @map("completed_at")     // When completed/failed
  
  @@map("evaluation_jobs")
  @@index([status])
  @@index([createdAt])
  @@index([cvFileId])
  @@index([projectReportFileId])
}
